<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>콩콩춘식 - 챌린지 결과 고도화</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poetsen+One&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@rive-app/canvas@latest"></script>
    <style>
        body { margin: 0; background: #333; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #game-stage { 
            position: relative; width: 393px; height: 852px; 
            background-color: #FFFDF5; background-size: 100% auto; background-repeat: repeat-y; overflow: hidden; 
        }

        /* --- 메인 화면 --- */
        #main-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('bg_main.png'); background-size: 100% 100%; z-index: 2000; }
        #main-rive-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #main-canvas { width: 100%; height: 100%; }
        #start-button {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            width: 340px; height: 75px; background-image: url('btn_start.png'); background-size: contain; 
            background-repeat: no-repeat; background-position: center; cursor: pointer; border: none; background-color: transparent; z-index: 2001;
        }

        /* --- 결과 화면 --- */
        #result-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.65); /* 딤드 65% */
            z-index: 3000; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .result-card {
            width: 345px; /* 좌우 마진 24px 적용 */
            background: #FFF; border-radius: 30px; padding: 32px 24px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            box-sizing: border-box;
            transform: translateY(30px); opacity: 0; transition: all 0.4s ease-out;
        }
        #result-screen.show .result-card { transform: translateY(0); opacity: 1; }
        
        .res-title { font-size: 20px; font-weight: 700; color: #000; margin-bottom: 24px; }
        
        .res-info-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 0 10px; }
        .res-info-label { display: flex; align-items: center; font-size: 16px; font-weight: 700; color: #333; }
        .res-info-label img { width: 22px; height: 22px; margin-right: 8px; }
        .res-info-value { font-size: 18px; font-weight: 800; color: #333; }

        .res-total-value { 
            font-size: 58px; font-weight: 900; color: #333; 
            margin: 20px 0 10px; 
            font-family: 'Poetsen One', sans-serif;
            letter-spacing: -1px;
        }

        .result-buttons { 
            display: flex; gap: 10px; 
            width: 345px; 
            margin-top: 20px; 
            box-sizing: border-box;
        }
        .btn-res { flex: 1; height: 64px; border: none; border-radius: 16px; font-size: 18px; font-weight: 800; cursor: pointer; }
        #btn-go-main { background: #2D2D2D; color: #FFF; } 
        #btn-retry { background: #F68679; color: #FFF; } 

        /* --- 인게임 UI --- */
        #ingame-ui { display: none; }
        #btn-close-wrap { position: absolute; top: 16px; left: 4px; width: 44px; height: 44px; z-index: 1001; cursor: pointer; }
        #btn-close-wrap img { width: 100%; height: 100%; display: block; object-fit: contain; }
        .header-ui-container { position: absolute; top: 75px; left: 0; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-sizing: border-box; z-index: 1000; }
        #score-board { font-family: 'Poetsen One', sans-serif; font-size: 38px; color: #2D1D1C; line-height: 1; }
        .rate-capsule { display: flex; align-items: center; justify-content: space-between; background: #FFFFFF; border: 2px solid #F0E0C6; border-radius: 30px; width: 110px; height: 46px; box-sizing: border-box; padding: 0 15px; }
        #rate-board { font-size: 20px; font-weight: 800; color: #2D1D1C; font-family: 'Arial', sans-serif; }

        /* --- 게임 요소 --- */
        #canvas-container { position: absolute; width: 86px !important; height: 138px !important; bottom: 100px; left: 50%; margin-left: -43px; z-index: 10; display: none; }
        canvas { width: 100%; height: 100%; }
        .platform { position: absolute; background-size: 100% 100%; z-index: 5; transition: opacity 0.2s; }
        .mouse-enemy { position: absolute; width: 72px; height: 54px; background-size: contain; background-repeat: no-repeat; z-index: 6; }
        .damage-effect { position: absolute; width: 60px; height: 60px; background-size: contain; background-repeat: no-repeat; z-index: 5.5; pointer-events: none; }
        .game-item { position: absolute; width: 50px; height: 50px; background-size: contain; background-repeat: no-repeat; z-index: 7; }
        .pickup-effect { position: absolute; width: 160px; height: 80px; background-image: url('effect_pickup.png'); background-size: contain; background-repeat: no-repeat; z-index: 120; pointer-events: none; transition: transform 0.8s, opacity 0.8s; }
        .wood-chunk { position: absolute; background-color: #A1887F; z-index: 4; pointer-events: none; border-radius: 1px; }

        .controller { position: absolute; width: 80px; height: 80px; background-size: contain; z-index: 50; cursor: pointer; display: none; }
        #btn-left { left: 30px; bottom: 40px; transform: scaleX(-1); }
        #btn-right { right: 30px; bottom: 40px; }
        .ctrl-default { background-image: url('controller_Default.png'); }
        .ctrl-pressed { background-image: url('controller_pressed.png'); }
        .gold-glow { filter: drop-shadow(0 0 15px gold); }
    </style>
</head>
<body>

<div id="game-stage">
    <div id="main-screen">
        <div id="main-rive-container"><canvas id="main-canvas"></canvas></div>
        <button id="start-button" onclick="startGame()"></button>
    </div>

    <div id="result-screen">
        <div class="result-card">
            <div class="res-title">챌린지 결과</div>
            <div class="res-info-row">
                <div class="res-info-label"><img src="pogo_s.png" alt="pogo"> 올라간 거리</div>
                <div class="res-info-value" id="res-distance">0m</div>
            </div>
            <div class="res-info-row">
                <div class="res-info-label"><img src="clover_s.png" alt="clover"> 클로버 획득</div>
                <div class="res-info-value" id="res-clover">0개</div>
            </div>
            <div class="res-total-value" id="res-total">0.00%</div>
        </div>
        <div class="result-buttons">
            <button class="btn-res" id="btn-go-main" onclick="location.reload();">메인 화면 가기</button>
            <button class="btn-res" id="btn-retry" onclick="location.reload();">재도전</button>
        </div>
    </div>

    <div id="ingame-ui">
        <div id="btn-close-wrap" onclick="location.reload();"><img src="close.png" alt="close"></div>
        <div class="header-ui-container">
            <div id="score-board">0m</div>
            <div class="rate-capsule"><img src="clover_s.png" style="width:25px;" alt="clover"><span id="rate-board">0</span></div>
        </div>
    </div>
    
    <div id="canvas-container"><canvas id="canvas"></canvas></div>
    <div id="btn-left" class="controller ctrl-default"></div>
    <div id="btn-right" class="controller ctrl-default"></div>
</div>

<script>
// 이미지 프리로딩
const preloadImages = [
    'effect_damage1.png', 'effect_damage2.png', 'effect_damage3.png',
    'mouse3.png', 'mouse2.png', 'mouse_walk1.png', 'mouse_walk2.png',
    'item_clover.png', 'item_gold.png', 'wood_1.png', 'wood_2.png', 'wood_3.png',
    'block_1.png', 'block_2.png', 'block_3.png', 'pogo_s.png'
];
preloadImages.forEach(src => { const img = new Image(); img.src = src; });

const PHYSICS = { gravity: 0.81, jumpPower: -18.9, superJumpPower: -45, moveSpeed: 7, motionHold: 10 };
const PLATFORM_TYPES = { wood: ['wood_1.png', 'wood_2.png', 'wood_3.png'], block: ['block_1.png', 'block_2.png', 'block_3.png'] };
const SIZES = [138, 98, 58];

let isPlaying = false, isSuperJumping = false, isGameOver = false;
let currentY = 0, velocityY = 0, posX = 0, score = 0, cloverCount = 0, bgScrollY = 0;
let maxReachY = 0;
let riveInstance, keys = {}, currentScale = 1, platforms = [], woodParticles = [], motionTimer = 0, lastLoadedFile = "", mouseAnimFrame = 0;

const mainRive = new rive.Rive({
    src: 'kongsik.riv',
    canvas: document.getElementById('main-canvas'),
    autoplay: true,
    stateMachines: 'State Machine 1',
    onLoad: () => mainRive.resizeDrawingSurfaceToCanvas()
});

function startGame() {
    document.getElementById('main-screen').style.display = 'none';
    document.getElementById('ingame-ui').style.display = 'block';
    document.getElementById('canvas-container').style.display = 'block';
    document.querySelectorAll('.controller').forEach(el => el.style.display = 'block');
    document.getElementById('game-stage').style.backgroundImage = "url('bg_ingame.png')";
    isPlaying = true; isGameOver = false;
    initPlatforms();
}

function showResult() {
    isPlaying = false; isGameOver = true;
    const finalDist = Math.floor(score * 0.01);
    const totalRate = (score * 0.0001) + (cloverCount * 0.1);
    
    document.getElementById('res-distance').innerText = `${finalDist}m`;
    document.getElementById('res-clover').innerText = `${cloverCount}개`;
    document.getElementById('res-total').innerText = `${totalRate.toFixed(2)}%`;
    
    const screen = document.getElementById('result-screen');
    screen.style.display = 'flex';
    setTimeout(() => screen.classList.add('show'), 10);
}

function loadRive(fileName) {
    if (lastLoadedFile === fileName) return;
    lastLoadedFile = fileName;
    if (riveInstance) riveInstance.cleanup();
    riveInstance = new rive.Rive({ src: fileName, canvas: document.getElementById('canvas'), autoplay: true, stateMachines: 'State Machine 1', onLoad: () => riveInstance.resizeDrawingSurfaceToCanvas() });
}

const setInput = (key, isDown, btn) => { if(isGameOver) return; keys[key] = isDown; if(btn) btn.classList.toggle('ctrl-pressed', isDown); };
window.addEventListener('keydown', (e) => { 
    if (e.code === 'ArrowLeft') setInput('ArrowLeft', true, document.getElementById('btn-left')); 
    if (e.code === 'ArrowRight') setInput('ArrowRight', true, document.getElementById('btn-right')); 
});
window.addEventListener('keyup', (e) => { 
    if (e.code === 'ArrowLeft') setInput('ArrowLeft', false, document.getElementById('btn-left')); 
    if (e.code === 'ArrowRight') setInput('ArrowRight', false, document.getElementById('btn-right')); 
});
const attachControl = (btn, key) => {
    btn.addEventListener('touchstart', (e) => { e.preventDefault(); setInput(key, true, btn); }, {passive: false});
    btn.addEventListener('touchend', (e) => { e.preventDefault(); setInput(key, false, btn); }, {passive: false});
};
attachControl(document.getElementById('btn-left'), 'ArrowLeft');
attachControl(document.getElementById('btn-right'), 'ArrowRight');

class WoodParticle {
    constructor(x, y) {
        this.x = x; this.y = y;
        this.vx = (Math.random() - 0.5) * 12; this.vy = (Math.random() - 0.5) * 12 - 4;
        this.size = 2 + Math.random() * 3; this.rotation = Math.random() * 360;
        this.life = 1.0;
    }
    update() { this.x += this.vx; this.y += this.vy; this.vy += 0.45; this.life -= 0.025; }
}

function createPlatformData(yPos) {
    let distM = Math.floor(score * 0.01);
    const rand = Math.random();
    let sizeIdx = distM < 100 ? Math.floor(rand * 2) : Math.floor(rand * SIZES.length);
    const width = SIZES[sizeIdx];
    let isBreakable = (rand < 0.15 + (Math.min(distM, 500) / 500) * 0.75);
    let moveType = rand < Math.min(0.5, 0.1 + (0.4 * (distM / 500))) ? (distM < 150 ? 'h' : (Math.random() > 0.5 ? 'h' : 'v')) : 'normal';
    let canHaveMouse = (width >= 98) && (rand < 0.2); 
    let itemType = (!canHaveMouse && rand > 0.8) ? (Math.random() > 0.8 ? 'gold' : 'clover') : null;
    
    return { 
        x: Math.random() * (393 - width), y: yPos, baseY: yPos, w: width, h: 22, 
        img: PLATFORM_TYPES[isBreakable?'wood':'block'][sizeIdx], 
        isBreakable, 
        hasMouse: canHaveMouse, mouseX: Math.random() * (width - 72), mouseDir: 1, mouseSpeed: 0.7 + Math.random() * 0.6, mouseWaitTimer: 0, mouseYOffset: -52, mouseVY: 0,
        mouseHit: false, mouseHitTimer: 0, mouseStunTimer: 0, 
        item: itemType, itemCollected: false, type: moveType, speed: 1.6, verticalRange: 40 + Math.random() * 40, vPhase: Math.random() * Math.PI * 2, isBroken: false 
    };
}

function initPlatforms() {
    score = 0; cloverCount = 0; currentY = 0; velocityY = 0; posX = 0; woodParticles = []; bgScrollY = 0; maxReachY = 0;
    document.getElementById('score-board').innerText = "0m";
    document.getElementById('rate-board').innerText = "0";
    platforms = [];
    let lastY = 752;
    for (let i = 0; i < 7; i++) { lastY -= (120 + Math.random() * 80); platforms.push(createPlatformData(lastY)); }
    platforms.push({ x: 393/2-69, y: 752, baseY: 752, w: 138, h: 22, img: 'block_1.png', isBreakable: false, isBroken: false, type: 'normal' });
    loadRive('kongsik_ingame_air.riv');
}

function spawnPickupEffect(x, y) {
    const eff = document.createElement('div');
    eff.className = 'pickup-effect';
    eff.style.left = (x - 80) + 'px'; eff.style.top = (y - 40) + 'px';
    document.getElementById('game-stage').appendChild(eff);
    setTimeout(() => { eff.style.transform = 'translateY(-80px)'; eff.style.opacity = '0'; }, 10);
    setTimeout(() => eff.remove(), 800);
}

function update() {
    if (!isPlaying) { if(!isGameOver) requestAnimationFrame(update); return; }
    if (keys['ArrowLeft']) { posX -= PHYSICS.moveSpeed; currentScale = -1; }
    if (keys['ArrowRight']) { posX += PHYSICS.moveSpeed; currentScale = 1; }
    posX = Math.max(-153, Math.min(153, posX));
    velocityY += isSuperJumping ? PHYSICS.gravity * 0.5 : PHYSICS.gravity;
    currentY += velocityY;
    mouseAnimFrame = (mouseAnimFrame + 1) % 20;

    let currentTotalY = -currentY + bgScrollY;
    if (currentTotalY > maxReachY) {
        maxReachY = currentTotalY;
        score = maxReachY; 
        document.getElementById('score-board').innerText = Math.floor(score * 0.01) + "m";
    }
    
    if (isSuperJumping && velocityY >= 0) { isSuperJumping = false; document.getElementById('canvas-container').classList.remove('gold-glow'); }
    woodParticles.forEach(p => p.update());
    woodParticles = woodParticles.filter(p => p.life > 0);
    const charFootY = 752 + currentY, charLeft = 393/2 + posX - 25;

    platforms.forEach(p => {
        if (p.hasMouse) {
            if (p.mouseHitTimer > 0) p.mouseHitTimer--; 
            if (p.mouseStunTimer > 0) { p.mouseStunTimer--; if (p.mouseStunTimer <= 0) p.mouseHit = false; }
            if (!p.isBroken) {
                if (p.mouseWaitTimer > 0) p.mouseWaitTimer--;
                else { if(!p.mouseHit) { p.mouseX += p.mouseDir * p.mouseSpeed; if (p.mouseX <= 0 || p.mouseX + 72 >= p.w) { p.mouseDir *= -1; p.mouseWaitTimer = 30; } } }
                let mx = p.x + p.mouseX, my = p.y - 35;
                if (!isSuperJumping && velocityY > 0 && charLeft + 35 > mx + 28 && charLeft + 15 < mx + 44 && charFootY > my + 10 && charFootY < my + 35) { 
                    velocityY = -15; posX += (posX > (mx - p.x) ? 100 : -100); p.mouseHit = true; p.mouseHitTimer = 15; p.mouseStunTimer = 60; 
                }
            } else { p.mouseVY += 0.6; p.mouseYOffset += p.mouseVY; }
        }

        if (!p.isBroken) {
            if (p.type === 'h') { p.x += p.speed; if (p.x <= 0 || p.x + p.w >= 393) p.speed *= -1; } 
            else if (p.type === 'v') { p.vPhase += 0.03; p.y = p.baseY + Math.sin(p.vPhase) * p.verticalRange; }
            if (p.item && !p.itemCollected) {
                let ix = p.x + p.w/2 - 25, iy = p.y - 55;
                if (charLeft + 45 > ix && charLeft + 5 < ix + 50 && charFootY > iy && charFootY < iy + 50) {
                    p.itemCollected = true;
                    if (p.item === 'clover') { cloverCount++; document.getElementById('rate-board').innerText = `${cloverCount}`; spawnPickupEffect(ix + 25, iy); } 
                    else if (p.item === 'gold') { isSuperJumping = true; velocityY = PHYSICS.superJumpPower; document.getElementById('canvas-container').classList.add('gold-glow'); loadRive('kongsik_ingame_air.riv'); }
                }
            }
            if (!isSuperJumping && velocityY > 0 && charLeft + 45 > p.x && charLeft + 5 < p.x + p.w && charFootY >= p.y && charFootY <= p.y + 15) { 
                loadRive('kongsik_ingame_land.riv'); velocityY = PHYSICS.jumpPower; currentY = p.y - 752; motionTimer = PHYSICS.motionHold;
                if (p.isBreakable) { p.isBroken = true; for(let i=0; i<15; i++) woodParticles.push(new WoodParticle(p.x + p.w/2, p.y)); }
            }
        }
    });

    if (motionTimer > 0) { motionTimer--; if (motionTimer === 1) loadRive('kongsik_ingame_air.riv'); }
    if (currentY < -250) {
        let diff = -250 - currentY; currentY = -250; bgScrollY += diff; 
        document.getElementById('game-stage').style.backgroundPositionY = (bgScrollY % 852) + 'px';
        platforms.forEach(p => { p.y += diff; p.baseY += diff; if (p.y > 852 && p.baseY > 852) { let topY = Math.min(...platforms.map(pl => pl.y)); Object.assign(p, createPlatformData(topY - (120 + Math.random() * 80))); p.isBroken = false; } });
        woodParticles.forEach(p => p.y += diff);
    }
    if (charFootY > 1050) showResult();
    document.getElementById('canvas-container').style.transform = `translate(${posX}px, ${currentY}px) scaleX(${currentScale})`;
    
    const stage = document.getElementById('game-stage');
    document.querySelectorAll('.platform, .mouse-enemy, .game-item, .wood-chunk, .damage-effect').forEach(el => el.remove());
    woodParticles.forEach(p => { const chunk = document.createElement('div'); chunk.className = 'wood-chunk'; chunk.style.cssText = `left:${p.x}px; top:${p.y}px; width:${p.size}px; height:${p.size}px; opacity:${p.life};`; stage.appendChild(chunk); });
    
    platforms.forEach(p => {
        if (!p.isBroken) {
            const d = document.createElement('div'); d.className = 'platform'; d.style.cssText = `left:${p.x}px;top:${p.y}px;width:${p.w}px;height:22px;background-image:url('${p.img}');`; stage.appendChild(d);
            if (p.item && !p.itemCollected) { const itemDiv = document.createElement('div'); itemDiv.className = 'game-item'; itemDiv.style.cssText = `left:${p.x + p.w/2 - 25}px; top:${p.y - 55}px; background-image:url('item_${p.item}.png');`; stage.appendChild(itemDiv); }
        }
        if (p.hasMouse) {
            if (p.mouseHit && p.mouseHitTimer > 0) {
                const eff = document.createElement('div'); eff.className = 'damage-effect';
                let effImg = p.mouseHitTimer > 10 ? 'effect_damage1.png' : (p.mouseHitTimer > 5 ? 'effect_damage2.png' : 'effect_damage3.png');
                eff.style.left = (p.x + p.mouseX + 6) + 'px'; eff.style.top = (p.y + p.mouseYOffset - 10) + 'px'; eff.style.backgroundImage = `url('${effImg}')`;
                stage.appendChild(eff);
            }
            const m = document.createElement('div'); m.className = 'mouse-enemy'; 
            let mouseImg = p.mouseHit ? 'mouse3.png' : (p.mouseWaitTimer > 0 || p.isBroken ? 'mouse2.png' : `mouse_walk${mouseAnimFrame < 10 ? 1 : 2}.png`);
            m.style.cssText = `left:${p.x + p.mouseX}px; top:${p.y + p.mouseYOffset}px; background-image:url('${mouseImg}'); transform:scaleX(${p.mouseDir});`; 
            stage.appendChild(m); 
        }
    });
    requestAnimationFrame(update);
}
update();
</script>
</body>
</html>
